<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="boydog" />
    <title>boydog-noot flat</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
      integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn/6.4.2/acorn.min.js"
      integrity="sha512-5McC9yHdohQSaKZHRkGbyD84OUdkgK8Cv89km3Tb8zA2ns9yyDU3yOPLeYB2X6NzM4qbu7rpjFUftjf5X/z0SQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn-walk/6.2.0/walk.min.js"
      integrity="sha512-Q57dc6D3mm13he5p7wUxJsTSRsETCo0Z/SU9u9YfKRiuWGsx7U02+tCpgaUUi4RJ8rQB2DofcWqXbvgBLCUcSQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"
      integrity="sha512-90vH1Z83AJY9DmlWa8WkjkV79yfS2n2Oxhsi2dZbIv0nC4E6m5AbH8Nh156kkM7JePmqD6tcZsfad1ueoaovww=="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/astring@1.4.3/dist/astring.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cash/8.1.0/cash.min.js"
      integrity="sha512-sgDgZX/GgfD7qSeMjPN/oE9EQgXZJW55FIjdexVT60QerG2gAWhR9QDQEGt3O90Dy9jVcwMWsoTMhLgldIiKXw=="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <div>
      <ul>
        <li bd-loop="items>\d+>">
          <p>todo: <input bd-value="$$todo" /></p>
        </li>
      </ul>
    </div>
    <script>
      const bdProcess = (() => {
        const prefix = "bd"
        const attrLoop = `${prefix}-loop`
        const attrNormal = [`${prefix}-value`, `${prefix}-id`]

        let scope = {}
        let modelScope = {}

        const getMatches = (str) => {
          const matches = Object.keys(scope)
            .map((e) => {
              const m = e.match(new RegExp(`^(.*)(${str})(.*)$`)) || []
              return { "$<": m[1], $$: m[2], "$>": m[3] }
            })
            .filter((e) => e.$$ !== undefined)

          return matches
        }

        const processLoops = () => {
          $(`[${attrLoop}]`).each((i, el) => {
            el = $(el)

            // Save blueprint if needed
            if (!el.bdBlueprintView) el.bdBlueprintView = el.clone().removeAttr(attrLoop)

            // Process element 0
            el.find("[bd-value*='$$']").each((i, f) => {
              f = $(f)

              if (f.closest(`[${attrLoop}]`)[0] !== el[0]) {
                // When element found is under another bd-loop (TODO: fix)
                return
              }
              f.attr("_bd-value-original", f.attr("bd-value"))
            })

            // Get matches
            const parent = el.parent()
            const matches = getMatches(el.attr(attrLoop))

            // Check if there are more or less elements
            const newL = matches.length
            const currentL = el.attr("_bd-last-matches")
            if (+newL === +currentL) return // Return since the elements are the same
            el.attr("_bd-last-matches", newL)

            matches.forEach((m, key) => {
              if (key === 0) return
              parent.append(el.bdBlueprintView.clone())
            })

            // Bake match structures
            parent.children().each((key, el) => {
              el = $(el)

              el.find("[bd-value*='$$']").each((i, f) => {
                f = $(f)
                // TODO: Fix when element found is under another bd-loop
                f.attr("bd-value", f.attr("bd-value").replace("$$", matches[key]["$$"]))
              })
            })
          })
        }

        const bindElements = () => {
          $("[bd-value]").each((i, el) => {
            _el = el // TODO: change this, better to use $ or not do this switch (USE JQUERY)
            el = $(el)

            const arrPath = el.attr("bd-value")

            console.log("binding", el, arrPath, scope)
            el.val(scope[arrPath])

            if (modelScope[arrPath] !== []) modelScope[arrPath] = []
            modelScope[arrPath].push(() => {
              const currentVal = scope[arrPath]
              if (_el.value === currentVal) return // Bailout if there is no need to update

              const selS = _el.selectionStart
              const selE = _el.selectionEnd
              _el.value = currentVal // Set new value
              _el.selectionStart = selS
              _el.selectionEnd = selE

              return
            })

            el.on("input", (ev) => {
              const val = ev.target.value
              socket.send(JSON.stringify({ p: arrPath, v: val }))
              scope[arrPath] = val
            })
          })
        }

        const action = {
          "@init": (data) => {
            Object.assign(scope, JSON.parse(data))
            console.log("Connected and received scope", scope)
            processLoops()

            // DEBUG
            setTimeout(() => {
              processLoops()
            }, 1000)

            bindElements()
          },
        }

        const message = (msg) => {
          console.log("msg", msg)
        }

        return { action, message }
      })()
    </script>

    <!-- wsEngine -->
    <script>
      const socket = new ReconnectingWebSocket("ws://localhost:3091")

      // Socket events
      socket.onopen = () => {
        console.log("WebSocket open")
      }
      socket.onerror = (error) => {
        console.log(`WebSocket error: ${error}`)
      }
      socket.onmessage = (msg) => {
        msg = msg.data

        // For special actions
        if (msg[0] === "@") {
          const match = (msg.match(/@\w+\|/) || [])[0]
          try {
            bdProcess.action[match.slice(0, -1)](msg.substr(match.length))
          } catch (e) {
            console.log("Action received but handler not found or throws error", e)
          }

          return
        }

        try {
          msg = JSON.parse(msg)
        } catch (e) {
          console.log("Invalid message", e)
        }
        bdProcess.message(msg)
      }
    </script>
  </body>
</html>
