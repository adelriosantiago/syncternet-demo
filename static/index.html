<!--
  - Rock
  -> Plastic
  - Paper
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="boydog" />
    <title>boydog-noot flat</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
      integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn/6.4.2/acorn.min.js"
      integrity="sha512-5McC9yHdohQSaKZHRkGbyD84OUdkgK8Cv89km3Tb8zA2ns9yyDU3yOPLeYB2X6NzM4qbu7rpjFUftjf5X/z0SQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn-walk/6.2.0/walk.min.js"
      integrity="sha512-Q57dc6D3mm13he5p7wUxJsTSRsETCo0Z/SU9u9YfKRiuWGsx7U02+tCpgaUUi4RJ8rQB2DofcWqXbvgBLCUcSQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"
      integrity="sha512-90vH1Z83AJY9DmlWa8WkjkV79yfS2n2Oxhsi2dZbIv0nC4E6m5AbH8Nh156kkM7JePmqD6tcZsfad1ueoaovww=="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/astring@1.4.3/dist/astring.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cash/8.1.0/cash.min.js"
      integrity="sha512-sgDgZX/GgfD7qSeMjPN/oE9EQgXZJW55FIjdexVT60QerG2gAWhR9QDQEGt3O90Dy9jVcwMWsoTMhLgldIiKXw=="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <div>
      <ul>
        <li bd-loop="items>\d+>">
          <p>todo: <input bd-value="$$todo" /></p>
        </li>
      </ul>
      <button bd-click="@addItem">add item</button>
    </div>
    <script>
      // - Rock
      // -> Plastic
      // - Paper

      const bdProcess = (() => {
        const prefix = "bd"
        const attr = {
          loop: `${prefix}-loop`,
          normal: [`${prefix}-value`, `${prefix}-id`],
          internal: {
            blueprint: "_bd-blueprint",
            original: "_bd-value-original",
            lastMatches: "_bd-last-matches",
          },
        }

        let scope = {} // Contains latest values
        let modelScope = {} // Contains update functions

        const getMatches = (str) => {
          const matches = Object.keys(scope)
            .map((e) => {
              const m = e.match(new RegExp(`^(.*)(${str})(.*)$`)) || []
              return { "$<": m[1], $$: m[2], "$>": m[3] }
            })
            .filter((e) => e.$$ !== undefined)

          return matches
        }

        const processLoops = () => {
          $(`[${attr.loop}]`).each((i, el) => {
            el = $(el)

            // Save blueprint if needed
            if (el.attr(attr.internal.blueprint) === undefined) {
              el.attr(attr.internal.blueprint, el.clone().removeAttr(attr.loop).get(0).outerHTML.trim())
            }

            // Get matches
            const parent = el.parent()
            const matches = getMatches(el.attr(attr.loop))

            // Check if there are more elements or less elements
            const newL = matches.length
            const currentL = el.attr(attr.internal.lastMatches)
            if (+newL === +currentL) return // Return since the elements are the same
            el.attr(attr.internal.lastMatches, newL)

            // Create extra elements
            matches.forEach((m, key) => {
              if (key === 0) return
              if (key < +currentL) return
              parent.append($(el.attr(attr.internal.blueprint)).clone())
            })

            // Process element 0
            el.find("[bd-value*='$$']").each((i, f) => {
              f = $(f)

              if (f.closest(`[${attr.loop}]`)[0] !== el[0]) {
                // When element found is under another bd-loop (TODO: fix)
                return
              }
              f.attr(attr.internal.original, f.attr("bd-value"))
            })

            // Bake match structures
            parent.children().each((key, el) => {
              el = $(el)

              el.find("[bd-value*='$$']").each((i, f) => {
                f = $(f)
                // TODO: Fix when element found is under another bd-loop
                f.attr("bd-value", f.attr("bd-value").replace("$$", matches[key]["$$"]))
              })
            })
          })
        }

        const bindElements = () => {
          $("[bd-value]").each((i, el) => {
            el = $(el)

            const arrPath = el.attr("bd-value")

            el.val(scope[arrPath])

            if (modelScope[arrPath] !== []) modelScope[arrPath] = []
            modelScope[arrPath].push(() => {
              const currentVal = scope[arrPath]
              if (el.val() === currentVal) return // Bailout if there is no need to update

              const selS = el[0].selectionStart
              const selE = el[0].selectionEnd
              el[0].value = currentVal // Set new value
              el[0].selectionStart = selS
              el[0].selectionEnd = selE

              return
            })

            el.on("input", (ev) => {
              const val = ev.target.value
              socket.send(JSON.stringify({ p: arrPath, v: val }))
              scope[arrPath] = val
            })
          })

          $("[bd-click]").each((i, el) => {
            el = $(el)

            //TODO: Process actions, when clicking the action should be sent to the server
            el.on("click", (ev) => {
              socket.send(JSON.stringify({ p: "items>3>todo", v: "new item" }))
            })
          })
        }

        const action = {
          "@init": (data) => {
            Object.assign(scope, JSON.parse(data))
            console.log("Connected and received scope", scope)
            processLoops()
            bindElements()

            /*// DEBUG, SHOULD NOT ADD MORE ITEMS BECAUSE HTML IS ALREADY BAKED
            setTimeout(() => {
              processLoops()
            }, 1000)*/
          },
        }

        const message = (msg) => {
          console.log("msg", msg, modelScope)

          const newAdded = scope[msg.p] === undefined ? true : false
          scope[msg.p] = msg.v
          if (newAdded) {
            processLoops() // TODO: FIX this creating 3 more elements instead of 1
            bindElements()
          }

          // Run update functions
          if (modelScope[msg.p] === undefined) modelScope[msg.p] = [] //TODO: Ideally this line should not be needed as it should always exist
          modelScope[msg.p].forEach((f) => f())
        }

        return { action, message }
      })()
    </script>

    <!-- wsEngine module -->
    <script>
      // -> Rock
      // - Plastic
      // - Paper

      const socket = new ReconnectingWebSocket("ws://localhost:3091")

      // Socket events
      socket.onopen = () => {
        console.log("WebSocket open")
      }
      socket.onerror = (error) => {
        console.log(`WebSocket error: ${error}`)
      }
      socket.onmessage = (msg) => {
        msg = msg.data

        // For special actions
        if (msg[0] === "@") {
          const match = (msg.match(/@\w+\|/) || [])[0]
          try {
            bdProcess.action[match.slice(0, -1)](msg.substr(match.length))
          } catch (e) {
            console.log("Action received but handler not found or throws error", e)
          }

          return
        }

        try {
          msg = JSON.parse(msg)
        } catch (e) {
          console.log("Invalid message", e)
        }
        bdProcess.message(msg)
      }
    </script>
  </body>
</html>
