<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="boydog" />
    <title>boydog-noot flat</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
      integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cash/8.1.0/cash.min.js"
      integrity="sha512-sgDgZX/GgfD7qSeMjPN/oE9EQgXZJW55FIjdexVT60QerG2gAWhR9QDQEGt3O90Dy9jVcwMWsoTMhLgldIiKXw=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn/6.4.2/acorn.min.js"
      integrity="sha512-5McC9yHdohQSaKZHRkGbyD84OUdkgK8Cv89km3Tb8zA2ns9yyDU3yOPLeYB2X6NzM4qbu7rpjFUftjf5X/z0SQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn-walk/6.2.0/walk.min.js"
      integrity="sha512-Q57dc6D3mm13he5p7wUxJsTSRsETCo0Z/SU9u9YfKRiuWGsx7U02+tCpgaUUi4RJ8rQB2DofcWqXbvgBLCUcSQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"
      integrity="sha512-90vH1Z83AJY9DmlWa8WkjkV79yfS2n2Oxhsi2dZbIv0nC4E6m5AbH8Nh156kkM7JePmqD6tcZsfad1ueoaovww=="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/astring@1.4.3/dist/astring.min.js"></script>
  </head>

  <body>
    <div>word: <input bd-model="word" /></div>
    <script>
      const bdProcess = (() => {
        let scope = {}

        const initModels = () => {
          $("[bd-model]").each((i, el) => {
            const path = el.getAttribute("bd-model")
            scope[path] = ""

            $(el).on("input", (ev) => {
              const val = ev.target.value
              socket.send(JSON.stringify({ p: path, v: val }))
              scope[path] = val
            })
          })
        }

        const action = {
          "@connection": () => {
            console.log("action: @connection")
            initModels()
          },
        }

        const message = (msg) => {
          console.log("msg", msg)
        }

        return { action, message }
      })()
    </script>
    <script>
      const socket = new ReconnectingWebSocket("ws://localhost:3091")

      // Socket events
      socket.onopen = () => {
        console.log("WebSocket open")
      }
      socket.onerror = (error) => {
        console.log(`WebSocket error: ${error}`)
      }
      socket.onmessage = (msg) => {
        msg = msg.data

        // For special actions
        if (msg[0] === "@") {
          try {
            bdProcess.action[msg]()
          } catch (e) {
            // Action not found
          }
          return
        }

        try {
          msg = JSON.parse(msg)
        } catch (e) {
          // Invalid message
        }
        bdProcess.message(msg)
      }
    </script>
  </body>
</html>
