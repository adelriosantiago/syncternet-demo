<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="boydog" />
    <title>boydog-noot</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
      integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cash/8.1.0/cash.min.js"
      integrity="sha512-sgDgZX/GgfD7qSeMjPN/oE9EQgXZJW55FIjdexVT60QerG2gAWhR9QDQEGt3O90Dy9jVcwMWsoTMhLgldIiKXw=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn/6.4.2/acorn.min.js"
      integrity="sha512-5McC9yHdohQSaKZHRkGbyD84OUdkgK8Cv89km3Tb8zA2ns9yyDU3yOPLeYB2X6NzM4qbu7rpjFUftjf5X/z0SQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/acorn-walk/6.2.0/walk.min.js"
      integrity="sha512-Q57dc6D3mm13he5p7wUxJsTSRsETCo0Z/SU9u9YfKRiuWGsx7U02+tCpgaUUi4RJ8rQB2DofcWqXbvgBLCUcSQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"
      integrity="sha512-90vH1Z83AJY9DmlWa8WkjkV79yfS2n2Oxhsi2dZbIv0nC4E6m5AbH8Nh156kkM7JePmqD6tcZsfad1ueoaovww=="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/astring@1.4.3/dist/astring.min.js"></script>
  </head>

  <body>
    <div>
      thing: <input bd-model="thing" />
      <br/>
      <div bd-content="thing"></div>
      <br/>
      <br/>
      <br/>
      <input bd-model="word" />
      <br/>
      [bd-content]: <div bd-content="'sample ' + word + ';;;'">href</div></br/>
      [bd-html]: <div bd-html="'sample ' + word + ';;;'">href</div></br/>
      [bd-dangerous-html]: <div bd-dangerous-html="'sample ' + word + ';;;'">href</div></br/>
      <br/>
      <br/>
      <br/>
      data.name: <input bd-model="data.name" /> data.address: <input bd-model="data.address" />
      <br />
      data.name content:
      <div bd-content="data.name"></div>
      data.address content:
      <div bd-content="data.address"></div>

      <br />
      data content:
      <div bd-content="data"></div>
      <br />
      data content JSON:
      <div bd-content="JSON.stringify(data)"></div>

      <br />
      <br />
      <br />
      number:
      <div bd-content="number"></div>
      <br />
      <br />
      <br />
      list:
      <div bd-content="list[0]"></div>
      <br />
      <br />
      <br />
      bd-for:
      <ul>
        <li bd-for="items">item</li>
      </ul>
    </div>
    <script>
      const socket = new ReconnectingWebSocket("ws://localhost:3091")

      const allWindowProperties = Object.getOwnPropertyNames(window)

      const attrCalculables = {
        "bd-id": "id",
        "bd-class": "className",
        "bd-content": "textContent",
        "bd-html": (val, el) => {
          let temp = document.createElement("div")
          temp.textContent = val.replace(/[^\w. ]/gi, (c) => {
            return "&#" + c.charCodeAt(0) + ";"
          })
          el.innerHTML = temp.innerHTML
        },
        "bd-dangerous-html": "innerHTML",
        "bd-src": "src",
        "bd-for": (val, el) => {
          const elType = el.cloneNode()
          elType.removeAttribute("bd-for")
          const n = parseInt(val)

          // Process element 0
          el.innerHTML = val - n

          // Process all other elements
          for (let i = n - 1; i > 0; i--) {
            const elToInsert = elType.cloneNode()
            elToInsert.innerHTML = i
            el.insertAdjacentElement("afterend", elToInsert)
          }
        },
      }

      let scope = {}
      let modelScope = {} // For processing inputs and textareas (flat structure)
      let calcScope = {} // For processing calc changes (flat structure)

      const initModels = () => {
        $("[bd-model]").each((i, el) => {
          const arrPath = _.toPath(el.getAttribute("bd-model"))

          _.set(scope, arrPath, "")

          const flatPath = arrPath.join(">")
          if (modelScope[flatPath] !== []) modelScope[flatPath] = []
          modelScope[flatPath].push(() => {
            const currentVal = _.get(scope, arrPath)
            if (el.value === currentVal) return // Bailout if there is no need to update

            const selS = el.selectionStart
            const selE = el.selectionEnd
            el.value = currentVal // Set new value
            el.selectionStart = selS
            el.selectionEnd = selE
            return
          })

          $(el).on("input", (ev) => {
            const val = ev.target.value
            socket.send(JSON.stringify({ p: flatPath, v: val }))
            _.set(scope, arrPath, val)
          })
        })
      }

      const initCalculables = () => {
        const addCalculable = (path, attr, attrVal, el) => {
          if (!Array.isArray(calcScope[path])) calcScope[path] = []

          const sandboxFn = new Function(
            "sandbox",
            `with (sandbox) { try { return ${attrVal}; } catch(e) { return ""; } }`
          )

          const parentsArr = path.split(">")
          parentsArr.pop()

          if (typeof attrCalculables[attr] === "function") {
            calcScope[path].push(() => {
              attrCalculables[attr](sandboxFn(scope), el)
              return
            })
          } else {
            calcScope[path].push(() => {
              el[attrCalculables[attr]] = sandboxFn(scope)
              // Update parents
              parentsArr.forEach((p) => {
                if (calcScope[p]) calcScope[p].forEach((f) => f())
              })
              return
            })
          }
        }

        Object.keys(attrCalculables).forEach((attr) => {
          $(`[${attr}]`).each((i, el) => {
            const attrVal = el.getAttribute(attr)
            const pathObj = acorn.parse(attrVal, { ecmaVersion: 8 })

            let found = []
            acorn.walk.simple(pathObj, {
              Identifier(node) {
                const path = node.name
                found.push(path)
              },
              MemberExpression(node) {
                const path = astring.generate(node)
                found.push(path)
              },
            })

            // Clear variables that already exist in the browser
            for (let i = 0; i < found.length; i++) {
              if (_.get(window, found[i]) !== undefined) found[i] = undefined
            }
            found = found.filter((e) => e !== undefined)

            // Remove parents
            for (let i = 0; i < found.length - 1; i++) {
              if (found[i + 1].match(new RegExp(`^${found[i]}`))) {
                found[i] = undefined
                continue
              }
            }
            found = found.filter((e) => e !== undefined)

            // Add calculable
            found.forEach((p) => addCalculable(_.toPath(p).join(">"), attr, attrVal, el))
          })
        })
      }

      initModels()
      initCalculables()

      const specialActions = {
        "@refresh": () => {
          Object.values(calcScope).forEach((a) => {
            a.forEach((f) => f())
          })
        },
      }

      // Socket events
      socket.onopen = () => {
        console.log("WebSocket open")
      }
      socket.onerror = (error) => {
        console.log(`WebSocket error: ${error}`)
      }
      socket.onmessage = (msg) => {
        msg = msg.data

        // For special actions
        if (msg[0] === "@") return specialActions[msg]()

        // For normal commands
        msg = JSON.parse(msg)
        
        // TODO: Fix "boydog-noot-quicktype-bug" from Mattsz
        if (msg.t !== "p") {
          _.set(scope, msg.p.split(">"), msg.v)
          
          if (modelScope[msg.p] !== undefined) modelScope[msg.p].forEach((f) => f()) // Update bd-models
        }

        if (calcScope[msg.p] !== undefined) calcScope[msg.p].forEach((f) => f()) // Update calculables
      }
    </script>
  </body>
</html>
